services:
  migrator:
    build:
      context: .
      dockerfile: Dockerfile
      target: migrator
    env_file:
      - .env
    restart: 'no'
  seeder:
    build:
      context: .
      dockerfile: Dockerfile
      target: migrator
    env_file:
      - .env
    command: >-
      sh -lc "set -eu;
      echo '[Seeder] Starting seed job';
      echo '[Seeder] Generating Prisma client';
      bunx prisma generate --schema=node_modules/@trycompai/db/dist/schema.prisma;
      echo '[Seeder] Running seed script';
      bun packages/db/prisma/seed/seed.ts;
      echo '[Seeder] Seed job finished'"
    depends_on:
      migrator:
        condition: service_completed_successfully
    environment:
      FORCE_DATABASE_WIPE_AND_RESEED: ${FORCE_DATABASE_WIPE_AND_RESEED:-false}
    restart: 'no'
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: app
      args:
        NEXT_PUBLIC_BETTER_AUTH_URL: ${NEXT_PUBLIC_BETTER_AUTH_URL:-http://localhost:3000}
        NEXT_PUBLIC_PORTAL_URL: ${NEXT_PUBLIC_PORTAL_URL:-http://localhost:3002}
    ports:
      - '3000:3000'
    env_file:
      - .env
    environment:
      APP_ENVIRONMENT: ${APP_ENVIRONMENT:-local}
    depends_on:
      migrator:
        condition: service_completed_successfully
      seeder:
        condition: service_completed_successfully
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:3000/api/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
    command: sh -lc "node apps/app/server.js"

  portal:
    build:
      context: .
      dockerfile: Dockerfile
      target: portal
      args:
        BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3002}
    ports:
      - '3002:3000'
    env_file:
      - .env
    environment:
      APP_ENVIRONMENT: ${APP_ENVIRONMENT:-local}
    depends_on:
      migrator:
        condition: service_completed_successfully
      seeder:
        condition: service_completed_successfully
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:3002/ || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
