enum PolicyDisplayFormat {
  EDITOR
  PDF
}

model Policy {
  id               String              @id @default(dbgenerated("generate_prefixed_cuid('pol'::text)"))
  name             String
  description      String?
  status           PolicyStatus        @default(draft)
  content          Json[]
  draftContent     Json[]              @default([])
  frequency        Frequency?
  department       Departments?
  isRequiredToSign Boolean             @default(true)
  signedBy         String[]            @default([])
  reviewDate       DateTime?
  isArchived       Boolean             @default(false)
  displayFormat    PolicyDisplayFormat @default(EDITOR)
  pdfUrl           String?

  // Dates
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastArchivedAt  DateTime?
  lastPublishedAt DateTime?

  // Relationships
  organizationId   String
  organization     Organization                   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assigneeId       String?
  assignee         Member?                        @relation("PolicyAssignee", fields: [assigneeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  approverId       String?
  approver         Member?                        @relation("PolicyApprover", fields: [approverId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  policyTemplateId String?
  policyTemplate   FrameworkEditorPolicyTemplate? @relation(fields: [policyTemplateId], references: [id])
  controls         Control[]
  currentVersionId String?                        @unique
  currentVersion   PolicyVersion?                 @relation("PolicyCurrentVersion", fields: [currentVersionId], references: [id])
  pendingVersionId String?
  versions         PolicyVersion[]                @relation("PolicyVersions")

  @@index([organizationId])
}

model PolicyVersion {
  id        String   @id @default(dbgenerated("generate_prefixed_cuid('pv'::text)"))
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  policyId String
  policy   Policy @relation("PolicyVersions", fields: [policyId], references: [id], onDelete: Cascade)
  currentForPolicy Policy? @relation("PolicyCurrentVersion")

  // Version details
  version       Int
  content       Json[]
  pdfUrl        String?
  publishedById String?
  publishedBy   Member? @relation("PolicyVersionPublisher", fields: [publishedById], references: [id], onDelete: SetNull)
  changelog     String?

  @@unique([policyId, version])
  @@index([policyId])
  @@index([createdAt])
}
