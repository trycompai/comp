version: 0.2

phases:
  pre_build:
    commands:
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      - REPOSITORY_URI=$ECR_REPOSITORY_URI
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}
      - echo "Installing dependencies..."
      - curl -fsSL https://bun.sh/install | bash

  build:
    commands:
      # Environment setup
      - export PATH="/root/.bun/bin:$PATH"
      - export PGSSLMODE=require
      - export NEXT_TELEMETRY_DISABLED=1
      - export UV_THREADPOOL_SIZE=36
      - export NODE_OPTIONS="--max-old-space-size=65536"

      # Navigate to portal directory
      - cd apps/$APP_NAME

      # Install dependencies
      - echo "Installing dependencies..."
      - SKIP_ENV_VALIDATION=true bun install --frozen-lockfile --concurrent 36 || SKIP_ENV_VALIDATION=true bun install --concurrent 36
      - cd ../../

      # Generate Prisma client
      - echo "Generating Prisma client..."
      - cd packages/db && bun x prisma generate && cd ../../

      # Validate environment variables
      - echo "Validating environment variables..."
      - '[ -n "$STATIC_ASSETS_BUCKET" ] || { echo "âŒ STATIC_ASSETS_BUCKET is not set"; exit 1; }'

      # Type check (optional - skip if script doesn't exist)
      - echo "Type checking..."
      - cd apps/$APP_NAME && (bun run typecheck || echo "No typecheck script found, skipping...") && cd ../../

      # Build Next.js portal app
      - echo "Building Next.js portal application..."
      - cd apps/$APP_NAME
      - NODE_TLS_REJECT_UNAUTHORIZED=0 bun run build

      # Upload static assets to S3 (solves chunk drift issue)
      - echo "Uploading static assets to S3..."
      - |
        if [ -d ".next/static" ]; then
          echo "ðŸ“¦ Uploading .next/static/ files..."
          aws s3 sync .next/static/ s3://$STATIC_ASSETS_BUCKET/_next/static/ \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.map" \
            --delete
          echo "âœ… Uploaded static assets to S3"
        else
          echo "âš ï¸ No .next/static directory found"
        fi

      # Upload public assets to bucket root (not /public/ prefix)
      - |
        if [ -d "public" ]; then
          echo "ðŸ“¦ Uploading public/ files to bucket root..."
          aws s3 sync public/ s3://$STATIC_ASSETS_BUCKET/ \
            --cache-control "public, max-age=86400" \
            --exclude "*.map" \
            --exclude "_next/*"
          echo "âœ… Uploaded public assets to S3 root"
        else
          echo "âš ï¸ No public directory found"
        fi

      # Prepare standalone build for container
      - echo "Preparing standalone build..."
      - echo "DEBUG - Checking what Next.js built..."
      - ls -la .next/
      - ls -la .next/standalone/ || echo "No standalone directory"

      # Create container build directory
      - mkdir -p container-build

      # Copy standalone app (without static files)
      - echo "DEBUG - Copying standalone files (excluding static assets)..."
      - cp -r .next/standalone/apps/$APP_NAME/* container-build/ || echo "Standalone copy failed"

      # Copy node_modules from standalone build (contains minimal required dependencies)
      - echo "Copying standalone node_modules..."
      - cp -r .next/standalone/node_modules container-build/ || echo "No standalone node_modules"

      # Copy package.json and other necessary files
      - cp package.json container-build/ || echo "No package.json"
      - cp Dockerfile container-build/ || echo "No Dockerfile"

      # Ensure Prisma client is available (override standalone if needed)
      - echo "Ensuring Prisma client is available..."
      - mkdir -p container-build/node_modules/.prisma container-build/node_modules/@prisma
      - |
        if [ -d "../../node_modules/.prisma/client" ]; then
          echo "Copying Prisma client from monorepo root..."
          cp -r ../../node_modules/.prisma/client container-build/node_modules/.prisma/
        elif [ -d "node_modules/.prisma/client" ]; then
          echo "Copying Prisma client from app directory..."
          cp -r node_modules/.prisma/client container-build/node_modules/.prisma/
        else
          echo "Warning: No Prisma client found"
        fi
      - |
        if [ -d "../../node_modules/@prisma/client" ]; then
          echo "Copying @prisma/client from monorepo root..."
          cp -r "../../node_modules/@prisma/client" "container-build/node_modules/@prisma/"
        elif [ -d "node_modules/@prisma/client" ]; then
          echo "Copying @prisma/client from app directory..."
          cp -r "node_modules/@prisma/client" "container-build/node_modules/@prisma/"
        else
          echo "Warning: No @prisma/client found"
        fi

      # Debug: Verify container build contents
      - echo "DEBUG - Verifying container build directory..."
      - ls -la container-build/
      - ls -la container-build/node_modules/next/ || echo "âŒ Next.js module not found"
      - ls -la container-build/node_modules/.prisma/ || echo "âŒ Prisma client not found"

      # Build Docker image (static assets now served from S3)
      - echo "Building Docker image..."
      - docker build --build-arg BUILDKIT_INLINE_CACHE=1 -f container-build/Dockerfile -t $ECR_REPOSITORY_URI:$IMAGE_TAG container-build/
      - docker tag $ECR_REPOSITORY_URI:$IMAGE_TAG $ECR_REPOSITORY_URI:latest

  post_build:
    commands:
      - echo "Pushing images to ECR..."
      - docker push $ECR_REPOSITORY_URI:$IMAGE_TAG
      - docker push $ECR_REPOSITORY_URI:latest
      - echo "Updating ECS service..."
      - aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_NAME --force-new-deployment
      - 'printf "[{\"name\":\"%s-container\",\"imageUri\":\"%s\"}]" $APP_NAME $ECR_REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json'

cache:
  paths:
    - 'node_modules/**/*'
    - 'packages/db/node_modules/**/*'
    - '/root/.bun/install/cache/**/*'
    - '.next/cache/**/*'
    - 'bun.lock'

artifacts:
  files:
    - imagedefinitions.json
  name: ${APP_NAME}-build
