version: 0.2

env:
  variables:
    # Set to "true" to force build even if no API files changed
    FORCE_BUILD: "false"
  exported-variables:
    - SKIP_BUILD

phases:
  pre_build:
    commands:
      # =============================================================================
      # SKIP BUILD CHECK: Avoid unnecessary builds for UI-only or release commits
      # All pre_build commands in single script to ensure SKIP_BUILD persists
      # =============================================================================
      - |
        echo "ðŸ” Checking if build should be skipped..."
        SKIP_BUILD="false"
        
        # Get the commit message
        COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null || echo "")
        echo "Commit message: $COMMIT_MSG"
        
        # Check for [skip ci] in commit message (from semantic-release)
        if echo "$COMMIT_MSG" | grep -q '\[skip ci\]'; then
          echo "â­ï¸  Skipping build: commit contains [skip ci]"
          SKIP_BUILD="true"
        # Check if force build is enabled
        elif [ "$FORCE_BUILD" = "true" ]; then
          echo "ðŸ”¨ Force build enabled, proceeding..."
          SKIP_BUILD="false"
        else
          # Get changed files since the previous commit
          # For the first build or if git history is shallow, build anyway
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "FULL_BUILD")
          
          if [ "$CHANGED_FILES" = "FULL_BUILD" ]; then
            echo "ðŸ“¦ Cannot determine changed files, proceeding with full build..."
            SKIP_BUILD="false"
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            
            # Check if any API-related paths changed
            # Paths that should trigger API build:
            # - apps/api/** (API source code)
            # - packages/db/** (database schema/migrations)
            # - packages/integration-platform/** (used by API)
            # - packages/utils/** (shared utilities)
            # - package.json, bun.lock (root dependencies)
            API_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^(apps/api/|packages/db/|packages/integration-platform/|packages/utils/|package\.json|bun\.lock)' || true)
            
            if [ -z "$API_CHANGES" ]; then
              echo "â­ï¸  Skipping build: no API-related files changed"
              echo "Changed files were UI/docs only:"
              echo "$CHANGED_FILES"
              SKIP_BUILD="true"
            else
              echo "âœ… API-related files changed, proceeding with build:"
              echo "$API_CHANGES"
              SKIP_BUILD="false"
            fi
          fi
        fi
        
        echo "SKIP_BUILD=$SKIP_BUILD"
        
        # Write to file so subsequent phases can read it
        echo "SKIP_BUILD=$SKIP_BUILD" > /tmp/skip_build_env
        
        # Set variables needed by subsequent phases
        export REPOSITORY_URI=$ECR_REPOSITORY_URI
        COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
        export IMAGE_TAG=${COMMIT_HASH:=latest}
        echo "REPOSITORY_URI=$REPOSITORY_URI" >> /tmp/skip_build_env
        echo "IMAGE_TAG=$IMAGE_TAG" >> /tmp/skip_build_env
        
        # Only proceed with ECR login if we're not skipping
        if [ "$SKIP_BUILD" = "true" ]; then
          echo "â­ï¸  Skipping ECR login (build will be skipped)"
        else
          echo "Logging in to Amazon ECR..."
          aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
        fi
        
        # Install bun if not skipping
        if [ "$SKIP_BUILD" = "true" ]; then
          echo "â­ï¸  Skipping bun installation (build will be skipped)"
        else
          echo "Installing dependencies..."
          curl -fsSL https://bun.sh/install | bash
        fi

  build:
    commands:
      # All build commands wrapped in single script to properly skip when SKIP_BUILD is true
      - |
        # Source skip build decision from pre_build phase
        source /tmp/skip_build_env
        
        if [ "$SKIP_BUILD" = "true" ]; then
          echo "â­ï¸  Skipping build phase: no API-related changes detected"
          exit 0
        fi

        # Environment setup
        export PATH="/root/.bun/bin:$PATH"
        export PGSSLMODE=require
        export NODE_ENV=production
        export NEXT_TELEMETRY_DISABLED=1
        export UV_THREADPOOL_SIZE=36
        export NODE_OPTIONS="--max-old-space-size=65536"

        # Validate environment variables
        echo "Validating environment variables..."
        [ -n "$DATABASE_URL" ] || { echo "âŒ DATABASE_URL is not set"; exit 1; }
        [ -n "$BASE_URL" ] || { echo "âŒ BASE_URL is not set"; exit 1; }
        [ -n "$BETTER_AUTH_URL" ] || { echo "âŒ BETTER_AUTH_URL is not set"; exit 1; }
        [ -n "$TRUST_APP_URL" ] || { echo "âŒ TRUST_APP_URL is not set"; exit 1; }
        [ -n "$APP_AWS_BUCKET_NAME" ] || { echo "âŒ APP_AWS_BUCKET_NAME is not set"; exit 1; }
        [ -n "$APP_AWS_ACCESS_KEY_ID" ] || { echo "âŒ APP_AWS_ACCESS_KEY_ID is not set"; exit 1; }
        [ -n "$APP_AWS_SECRET_ACCESS_KEY" ] || { echo "âŒ APP_AWS_SECRET_ACCESS_KEY is not set"; exit 1; }

        # Install only API workspace dependencies
        echo "Installing API dependencies only..."
        bun install --filter=@comp/api --frozen-lockfile || bun install --filter=@comp/api --ignore-scripts || bun install --ignore-scripts

        # Build workspace packages
        echo "Building workspace packages..."
        cd packages/db && bun run build && cd ../..
        cd packages/integration-platform && bun run build && cd ../..

        echo "Building NestJS application..."
        echo "APP_NAME is set to $APP_NAME"
        echo "Current directory $(pwd)"
        echo "Available apps $(ls -la apps/)"
        cd apps/api
        echo "Changed to $(pwd)"
        bun run build

        echo "Checking build output..."
        ls -la dist/
        ls -la dist/apps/api/src/ || ls -la dist/src/
        [ -f "dist/apps/api/src/main.js" ] || [ -f "dist/src/main.js" ] || { echo "âŒ main.js not found"; exit 1; }

        mkdir -p ../docker-build
        # Handle both output structures (dist/apps/api/src or dist/src)
        if [ -d "dist/apps/api/src" ]; then
          echo "Using composite output structure..."
          cp -r dist/apps/api/* ../docker-build/
        else
          echo "Using standard output structure..."
          cp -r dist/* ../docker-build/
        fi
        cp -r prisma ../docker-build/
        echo "Verifying copied files..."
        ls -la ../docker-build/
        ls -la ../docker-build/src/
        [ -f "../docker-build/src/main.js" ] || { echo "âŒ main.js not found in docker-build/src"; exit 1; }

        # Copy ALL node_modules from root (already installed with production deps)
        echo "Copying node_modules from root..."
        cp -r ../../node_modules ../docker-build/

        # Remove workspace symlinks and replace with built versions
        rm -rf ../docker-build/node_modules/@trycompai/utils
        rm -rf ../docker-build/node_modules/@trycompai/db
        rm -rf ../docker-build/node_modules/@comp/integration-platform
        mkdir -p ../docker-build/node_modules/@trycompai/utils
        mkdir -p ../docker-build/node_modules/@trycompai/db
        mkdir -p ../docker-build/node_modules/@comp/integration-platform
        cp -r ../../packages/utils/src ../docker-build/node_modules/@trycompai/utils/
        cp ../../packages/utils/package.json ../docker-build/node_modules/@trycompai/utils/
        cp -r ../../packages/db/dist ../docker-build/node_modules/@trycompai/db/
        cp ../../packages/db/package.json ../docker-build/node_modules/@trycompai/db/
        cp -r ../../packages/integration-platform/dist ../docker-build/node_modules/@comp/integration-platform/
        cp ../../packages/integration-platform/package.json ../docker-build/node_modules/@comp/integration-platform/

        cp Dockerfile ../docker-build/
        # Remove workspace dependency from package.json (it's copied manually above)
        cat package.json | jq 'del(.dependencies["@comp/integration-platform"])' > ../docker-build/package.json
        cp ../../bun.lock ../docker-build/ || true

        echo "Building Docker image..."
        docker build --build-arg BUILDKIT_INLINE_CACHE=1 -t $ECR_REPOSITORY_URI:$IMAGE_TAG ../docker-build/
        docker tag $ECR_REPOSITORY_URI:$IMAGE_TAG $ECR_REPOSITORY_URI:latest

  post_build:
    commands:
      # All post-build commands wrapped in single script to properly skip when SKIP_BUILD is true
      - |
        # Source skip build decision and variables from pre_build phase
        source /tmp/skip_build_env
        
        if [ "$SKIP_BUILD" = "true" ]; then
          echo "â­ï¸  Skipping deployment: build was skipped"
          echo "âœ… Build completed successfully (no changes to deploy)"
          # Create empty artifact to satisfy CodePipeline
          echo '[]' > imagedefinitions.json
          exit 0
        fi

        echo "Pushing images to ECR..."
        docker push $ECR_REPOSITORY_URI:$IMAGE_TAG
        docker push $ECR_REPOSITORY_URI:latest
        echo "Updating ECS service..."
        aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_NAME --force-new-deployment
        printf "[{\"name\":\"%s-container\",\"imageUri\":\"%s\"}]" api $ECR_REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json

cache:
  paths:
    - 'node_modules/**/*'
    - 'packages/db/node_modules/**/*'
    - 'apps/api/node_modules/**/*'
    - '/root/.bun/install/cache/**/*'
    - 'bun.lock'

artifacts:
  files:
    - imagedefinitions.json
  name: ${APP_NAME}-build
