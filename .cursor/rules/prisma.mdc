---
description: Prisma schema conventions and migration workflow
globs: **/*.prisma
alwaysApply: false
---

# Prisma Schema

## Migration Workflow

**Schema changes happen in `packages/db`. The Prisma client is generated once and shared across all apps.**

### Step 1: Edit Schema

```bash
# Schema files are in packages/db/prisma/schema/
packages/db/prisma/schema/
├── user.prisma        # User models
├── task.prisma        # Task models
└── ...

# Generator and datasource config:
packages/db/prisma/schema.prisma
```

### Step 2: Create Migration

```bash
# Run from packages/db
cd packages/db
bunx prisma migrate dev --name your_migration_name
```

### Step 3: Regenerate Shared Client

```bash
# From root - generates once in packages/db, shared by all apps
bun run db:generate

# Or from packages/db directly
cd packages/db && bun run db:generate
```

### ✅ Always Do This

```bash
# 1. Make schema changes in packages/db/prisma/schema/
# 2. Create migration
cd packages/db && bunx prisma migrate dev --name add_user_role

# 3. Regenerate shared client (one command)
bun run db:generate
```

### ❌ Never Do This

```bash
# Don't create prisma schema files in app directories
apps/app/prisma/schema.prisma  # ❌ Wrong location

# Don't import from @prisma/client directly
import { Prisma } from '@prisma/client'  # ❌ Use @db instead
import { Prisma } from '@db'             # ✅ Correct
```

## Core Rule

**Always use prefixed CUIDs for IDs** using `generate_prefixed_cuid`.

## ID Pattern

### ✅ Always Do This

```prisma
model User {
  id String @id @default(dbgenerated("generate_prefixed_cuid('usr'::text)"))
  // ... other fields
}

model Task {
  id String @id @default(dbgenerated("generate_prefixed_cuid('tsk'::text)"))
  // ... other fields
}

model Organization {
  id String @id @default(dbgenerated("generate_prefixed_cuid('org'::text)"))
  // ... other fields
}
```

### ❌ Never Do This

```prisma
// Don't use UUID
model User {
  id String @id @default(uuid())
}

// Don't use auto-increment
model User {
  id Int @id @default(autoincrement())
}

// Don't forget ::text cast
model User {
  id String @id @default(dbgenerated("generate_prefixed_cuid('usr')")) // ❌ Missing ::text
}
```

## Prefix Guidelines

| Entity       | Prefix | Example ID                     |
| ------------ | ------ | ------------------------------ |
| User         | `usr`  | `usr_BJRIZLgRPuWt8MvMjkSY82f1` |
| Organization | `org`  | `org_cK9xMnPqRs2tUvWx3yZa4b5c` |
| Task         | `tsk`  | `tsk_dE6fGhIj7kLmNoP8qRsT9uVw` |
| Control      | `ctl`  | `ctl_xY0zAaBb1cDdEe2fFgGh3iIj` |
| Policy       | `pol`  | `pol_kK4lLmMn5oOpPq6rRsSt7uUv` |

## Rules

1. **Short prefixes** - Use 2-3 characters
2. **Unique prefixes** - Each model gets its own prefix
3. **Always cast** - Include `::text` in the function call
4. **Use dbgenerated** - Wrap the function call in `dbgenerated()`

## Benefits

- Human-readable IDs at a glance (`usr_` vs `org_`)
- Easy debugging in logs
- Safe to expose in URLs
- Unique across all tables

## Checklist

After schema changes:

- [ ] Schema edited in `packages/db/prisma/schema/`
- [ ] Migration created with `bunx prisma migrate dev`
- [ ] Shared client regenerated with `bun run db:generate`
- [ ] New models use prefixed CUID IDs
